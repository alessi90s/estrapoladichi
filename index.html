<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estrattore LM22 / LM35 / LM36 / LM39</title>
<style>
  :root{--bg:#f9fafb;--card:#fff;--border:#e5e7eb;--shadow:0 4px 10px rgba(0,0,0,.05);}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
  header{padding:2rem 1rem;text-align:center}
  main{max-width:1000px;margin:0 auto;padding:0 1rem 4rem}
  h1{margin:0 0 1rem;font-size:2rem}
  input[type=file]{margin:.5rem 0}
  #go{margin-left:.5rem;padding:.45rem 1.2rem;border:0;border-radius:6px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);transition:opacity .2s}
  #go:disabled{background:#9ca3af;cursor:not-allowed;opacity:.65}
  #status{margin:.75rem 0;min-height:1.25em;font-style:italic;font-size:.95rem}
  .err{color:#b91c1c}.ok{color:#047857}.info{color:#374151}
  .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:1rem}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{padding:.25rem .5rem;border-bottom:1px solid var(--border)}th{background:#f3f4f6;text-align:left}
  td:last-child{text-align:right}
  details summary{cursor:pointer;color:#2563eb}
  pre{white-space:pre-wrap;max-height:240px;overflow:auto;background:#f3f4f6;padding:.5rem;border-radius:8px;font-size:.8rem}
  em{color:#6b7280}
</style>
</head>
<body>
<header>
  <h1>Estrai voci LM22&nbsp;/ LM35&nbsp;/ LM36&nbsp;/ LM39</h1>

  <input type="file" id="file" accept="application/pdf">
  <button id="go" disabled>Estrai dati</button>
  <div id="status" class="info">Seleziona un PDF per iniziare</div>
</header>

<main>
  <div id="out" class="grid" style="display:none">
    <section class="card" id="lmBox">
      <h2>Quadro LM</h2>
      <div id="lmTbl"></div>
      <details><summary>RAW LM</summary><pre id="lmRaw"></pre></details>
    </section>
  </div>
</main>

<!-- pdf.js (core: nessun worker esterno) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- tesseract.js per l’OCR di emergenza -->
<script src="https://unpkg.com/tesseract.js@4.0.3/dist/tesseract.min.js"></script>

<script>
/* ---------- PATCH: blocca i web-worker di pdf.js ---------- */
if (window.Worker) {
  const OrigWorker = Worker;
  window.Worker = function (url) {
    if (url && url.toString().includes('pdf.worker')) throw new Error('Worker bloccato dal sandbox');
    return new OrigWorker(url);
  };
}
if (window.pdfjsLib) {                  // esegue pdf.js in “fake-worker” nel main-thread
  pdfjsLib.GlobalWorkerOptions.disableWorker = true;
  pdfjsLib.GlobalWorkerOptions.workerSrc = '';
}

/* ---------- VARIABILI DI STATO ---------- */
let buffer = null;                      // conterrà l’ArrayBuffer del PDF
const fileInput = document.getElementById('file');
const goBtn     = document.getElementById('go');
const $         = q => document.querySelector(q);
const setStatus = (txt, cls = 'info') => {
  const el = document.getElementById('status');
  el.textContent = txt;
  el.className = cls;
};

/* ---------- SELEZIONE FILE ---------- */
fileInput.addEventListener('change', async ev => {
  const file = ev.target.files[0];
  buffer = null;
  goBtn.disabled = true;
  $('#out').style.display = 'none';

  if (!file) {
    setStatus('Nessun file selezionato', 'err');
    return;
  }

  setStatus('PDF caricato, pronto all’estrazione', 'ok');
  buffer = await file.arrayBuffer();
  goBtn.disabled = false;               // abilita il pulsante!
});

/* ---------- CLICK SU “ESTRAI DATI” ---------- */
goBtn.addEventListener('click', async () => {
  if (!buffer) {
    setStatus('Seleziona prima un PDF', 'err');
    return;
  }

  goBtn.disabled = true;               // evita doppi clic
  setStatus('Lettura PDF…');
  $('#out').style.display = 'none';

  try {
    const txt = await extractText(buffer);
    setStatus('Parsing quadro LM…');
    const lm  = parseLM(txt);
    renderLM(lm.blockRaw, lm.data);

    if (Object.keys(lm.data).length) {
      setStatus('✓ Dati estratti con successo', 'ok');
    } else {
      setStatus('Quadro LM non trovato o valori non riconosciuti', 'err');
    }

    $('#out').style.display = 'grid';
  } catch (err) {
    console.error(err);
    setStatus('Errore: ' + err.message, 'err');
  } finally {
    goBtn.disabled = false;
  }
});

/* ---------- ESTRARRE TESTO (3 metodi) ---------- */
async function extractText(buf) {
  /* 1️⃣ pdf.js */
  if (window.pdfjsLib) {
    try {
      const doc = await pdfjsLib.getDocument({ data: buf }).promise;
      let out = '';
      for (let p = 1; p <= doc.numPages; p++) {
        const pg = await doc.getPage(p);
        const { items } = await pg.getTextContent();
        out += items.map(i => i.str).join(' ') + '\n';
      }
      if (out.replace(/\s+/g, '').length > 300) return out;
    } catch (e) { console.warn('pdf.js fallito', e); }
  }

  /* 2️⃣ decodifica grezza */
  let raw = new TextDecoder('latin1').decode(buf);
  if (raw.replace(/\s+/g, '').length > 300) return raw;

  /* 3️⃣ OCR (lento, solo se pdf.js presente) */
  if (window.pdfjsLib) {
    setStatus('OCR in corso – potrebbe richiedere tempo…');
    const doc = await pdfjsLib.getDocument({ data: buf }).promise;
    raw = '';
    for (let p = 1; p <= doc.numPages; p++) {
      setStatus(`OCR pagina ${p}/${doc.numPages}…`);
      const pg = await doc.getPage(p);
      const vp = pg.getViewport({ scale: 1.4 });
      const cv = document.createElement('canvas');
      cv.width = vp.width; cv.height = vp.height;
      await pg.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
      const { data: { text } } = await Tesseract.recognize(cv, 'ita');
      raw += text + '\n';
    }
  }
  return raw;
}

/* ---------- PARSING QUADRO LM ---------- */
function parseLM(allTxt) {
  const flat  = allTxt.replace(/\n+/g, ' ').replace(/\s{2,}/g, ' ').trim();
  const start = flat.search(/QUADRO LM/i) >= 0 ? flat.search(/QUADRO LM/i)
                : flat.search(/\bLM\d{1,3}\b/);
  if (start < 0) return { data: {}, blockRaw: '' };

  const nextQ = flat.slice(start).search(/QUADRO [A-Z]{1,2}/i);
  const block = nextQ > 0 ? flat.slice(start, start + nextQ) : flat.slice(start);
  const out   = {};

  // LM22
  const lm22 = block.match(/LM22\s+(\d{4,6})\s+(\d{1,3})%?\s+(\d[\d\.]*,[\d]{2})/i);
  if (lm22) {
    out['Codice ATECO']           = lm22[1];
    out['Coeff. redditività (%)'] = lm22[2];
    out['Componenti positivi']    = lm22[3];
  }
  // LM35
  const lm35 = block.match(/LM35[^\d]*(\d[\d\.]*,[\d]{2})/i);
  if (lm35) out['Contributi versati'] = lm35[1];
  // LM36
  const lm36 = block.match(/LM36[^\d]*(\d[\d\.]*,[\d]{2})/i);
  if (lm36) out['Reddito netto'] = lm36[1];
  // LM39
  const lm39 = block.match(/LM39[^\d]*(\d[\d\.]*,[\d]{2})/i);
  if (lm39) out['Imposta sostitutiva'] = lm39[1];

  return { data: out, blockRaw: block };
}

/* ---------- RENDER ---------- */
function renderLM(rawTxt, obj) {
  $('#lmRaw').textContent = rawTxt.slice(0, 5000) + (rawTxt.length > 5000 ? '…' : '');
  const box = $('#lmTbl');

  if (!Object.keys(obj).length) {
    box.innerHTML = '<em>Quadro LM non trovato o valori non estratti</em>';
    return;
  }

  const tbl = document.createElement('table');
  tbl.innerHTML = '<thead><tr><th>Campo</th><th>Valore</th></tr></thead>';
  const tb = document.createElement('tbody');

  Object.entries(obj).forEach(([k, v]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
    tb.appendChild(tr);
  });

  tbl.appendChild(tb);
  box.innerHTML = ''; box.appendChild(tbl);
}
</script>
</body>
</html>
