<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estrattore LM22 / LM35 / LM36 / LM39</title>
<style>
  :root{--bg:#f9fafb;--card:#fff;--border:#e5e7eb;--shadow:0 4px 10px rgba(0,0,0,.05);}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#111827}
  header{padding:2rem 1rem;text-align:center}
  main{max-width:1000px;margin:0 auto;padding:0 1rem 4rem}
  h1{margin:0 0 1rem;font-size:2rem}
  input[type=file]{margin:.5rem 0}
  #go{margin-left:.5rem;padding:.45rem 1.2rem;border:0;border-radius:6px;background:#2563eb;color:#fff;font-size:1rem;cursor:pointer;box-shadow:var(--shadow);transition:opacity .2s}
  #go:disabled{background:#9ca3af;cursor:not-allowed;opacity:.65}
  #status{margin:.75rem 0;min-height:1.25em;font-style:italic;font-size:.95rem}
  .err{color:#b91c1c}.ok{color:#047857}.info{color:#374151}
  .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:1rem}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{padding:.25rem .5rem;border-bottom:1px solid var(--border)}th{background:#f3f4f6;text-align:left}
  td:last-child{text-align:right}
  details summary{cursor:pointer;color:#2563eb}
  pre{white-space:pre-wrap;max-height:240px;overflow:auto;background:#f3f4f6;padding:.5rem;border-radius:8px;font-size:.8rem}
  em{color:#6b7280}
</style>
</head>
<body>
<header>
  <h1>Estrai voci&nbsp;LM22 / LM35 / LM36 / LM39</h1>
  <input type="file" id="file" accept="application/pdf">
  <button id="go" disabled>Estrai dati</button>
  <div id="status" class="info">Seleziona un PDF per iniziare</div>
</header>

<main>
  <div id="out" class="grid" style="display:none">
    <section class="card" id="lmBox">
      <h2>Quadro LM</h2>
      <div id="lmTbl"></div>
      <details><summary>RAW LM</summary><pre id="lmRaw"></pre></details>
    </section>
  </div>
</main>

<!-- pdf.js core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- tesseract.js -->
<script src="https://unpkg.com/tesseract.js@4.0.3/dist/tesseract.min.js"></script>

<script>
/* patch: niente worker */
if(window.Worker){
  const Orig=Worker;
  window.Worker=function(u){if(u&&u.toString().includes('pdf.worker'))throw new Error('worker bloccato');return new Orig(u);}
}
if(window.pdfjsLib){pdfjsLib.GlobalWorkerOptions.disableWorker=true;pdfjsLib.GlobalWorkerOptions.workerSrc='';}

/* helpers */
const $=q=>document.querySelector(q);
const setStatus=(t,c='info')=>{$('#status').textContent=t;$('#status').className=c;};

/* stato */
let buf=null;$('#file').addEventListener('change',async e=>{const f=e.target.files[0];$('#out').style.display='none';buf=null;$('#go').disabled=true;if(!f){setStatus('Nessun file selezionato','err');return;}buf=await f.arrayBuffer();setStatus('PDF caricato, pronto all’estrazione','ok');$('#go').disabled=false;});

$('#go').addEventListener('click',async()=>{if(!buf){setStatus('Seleziona prima un PDF','err');return;}$('#go').disabled=true;setStatus('Lettura PDF…');try{const txt=await extractText(buf);setStatus('Parsing LM…');const lm=parseLM(txt);renderLM(lm.blockRaw,lm.data);if(Object.keys(lm.data).length)setStatus('✓ Dati estratti','ok');else setStatus('Valori LM non trovati','err');$('#out').style.display='grid';}catch(err){console.error(err);setStatus('Errore: '+err.message,'err');}finally{$('#go').disabled=false;}});

/* estrazione testo */
async function extractText(b){if(window.pdfjsLib){try{const d=await pdfjsLib.getDocument({data:b}).promise;let o='';for(let p=1;p<=d.numPages;p++){const pg=await d.getPage(p);const {items}=await pg.getTextContent();o+=items.map(i=>i.str).join(' ')+'\\n';}if(o.replace(/\\s+/g,'').length>300)return o;}catch(e){}}
let raw=new TextDecoder('latin1').decode(b);if(raw.replace(/\\s+/g,'').length>300)return raw;
return raw;}

/* parsing LM con spazi/etichette */
function parseLM(t){const f=t.replace(/\\n+/g,' ').replace(/\\s{2,}/g,' ').trim();const s=f.search(/QUADRO LM/i)>=0?f.search(/QUADRO LM/i):f.search(/\\bLM\\s*\\d{1,3}\\b/);if(s<0)return{data:{},blockRaw:''};const e=f.slice(s).search(/QUADRO [A-Z]{1,2}/i);const blk=e>0?f.slice(s,s+e):f.slice(s);const o={};
/* 1. ATECO + coeff + comp. positivi  */
let m=blk.match(/Codice attività\\s+(\\d{4,6}).+?Coeff\\w*\\s+(\\d{1,3})%?.+?Componenti positivi[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i);
if(!m) m=blk.match(/LM\\s*22\\s+(\\d{4,6})\\s+(\\d{1,3})%?\\s+(\\d[\\d\\.]*,[\\d]{2})/i);
if(m){o['Codice ATECO']=m[1];o['Coeff. redditività (%)']=m[2];o['Componenti positivi']=m[3];}
/* 2. Contributi */
m=blk.match(/Contributi (?:previdenziali[\\w\\s]*?)?[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i)||blk.match(/LM\\s*35[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i);
if(m) o['Contributi versati']=m[1];
/* 3. Reddito netto */
m=blk.match(/Reddito netto[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i)||blk.match(/LM\\s*36[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i);
if(m) o['Reddito netto']=m[1];
/* 4. Imposta sostitutiva */
m=blk.match(/Imposta sostitutiva[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i)||blk.match(/LM\\s*39[^\\d]*(\\d[\\d\\.]*,[\\d]{2})/i);
if(m) o['Imposta sostitutiva']=m[1];

return{data:o,blockRaw:blk};}

/* rendering */
function renderLM(raw,d){$('#lmRaw').textContent=raw.slice(0,6000)+(raw.length>6000?'…':'');const box=$('#lmTbl');if(!Object.keys(d).length){box.innerHTML='<em>Nessun dato LM estratto</em>';return;}const tbl=document.createElement('table');tbl.innerHTML='<thead><tr><th>Campo</th><th>Valore</th></tr></thead>';const tb=document.createElement('tbody');Object.entries(d).forEach(([k,v])=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${k}</td><td>${v}</td>`;tb.appendChild(tr);});tbl.appendChild(tb);box.innerHTML='';box.appendChild(tbl);}
</script>
</body>
</html>
